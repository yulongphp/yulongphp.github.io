<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="一个苦逼屌丝程序员的技术博客"><title>PHP 代码安全杂谈 | Mryy的博客</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/3.0.3/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">PHP 代码安全杂谈</h1><a id="logo" href="/.">Mryy的博客</a><p class="description">生活不仅只是敲代码，还有...调bug...</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">PHP 代码安全杂谈</h1><div class="post-meta">Oct 25, 2018<span> | </span><span class="category"><a href="/categories/php/">php</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2018/10/25/PHP 代码安全杂谈/" href="/2018/10/25/PHP 代码安全杂谈/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>转载自: <a href="https://www.sqlsec.com/2018/01/php.html" target="_blank" rel="noopener">https://www.sqlsec.com/2018/01/php.html</a></p>
<blockquote>
<p>虽然 PHP 是世界上最好的语言, 但是也有一些因为弱类型语言的安全性问题出现。WordPress 历史上就出现过由于 PHP 本身的缺陷而造成的一些安全性问题，如 CVE-2014-0166 中的 cookie 伪造就是利用了 PHP Hash 比较的缺陷。 当然一般这种情况实战中用到的不是很多，但是在 CTF 竞赛中却是一个值得去考察的一个知识点，特此记录总结之。</p>
</blockquote>
<a id="more"></a>
<h3 id="精度绕过缺陷"><a href="#精度绕过缺陷" class="headerlink" title="精度绕过缺陷"></a>精度绕过缺陷</h3><h4 id="理论"><a href="#理论" class="headerlink" title="理论"></a>理论</h4><p>在用 PHP 进行浮点数的运算中, 经常会出现一些和预期结果不一样的值，这是由于浮点数的精度有限。尽管取决于系统，PHP 通常使用 <code>IEEE 754</code>双精度格式，则由于取整而导致的最大相对误差为 <code>1.11e-16</code>。非基本数学运算可能会给出更大误差，并且要考虑到进行复合运算时的误差传递。<br>下面看一个有趣的例子:<br><img src="/images/15170501261023.png" alt=""></p>
<p>以十进制能够精确表示的有理数如 <code>0.1</code> 或 <code>0.7</code>，无论有多少尾数都不能被内部所使用的二进制精确表示，因此不能在不丢失一点点精度的情况下转换为二进制的格式。这就会造成混乱的结果：例如，<code>floor((0.1+0.7)*10)</code> 通常会返回 <code>7</code> 而不是预期中的 <code>8</code>，因为该结果内部的表示其实是类似 <code>7.9999999999999991118…</code>。</p>
<h3 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h3><h5 id="问鼎杯-2017-老眼昏花"><a href="#问鼎杯-2017-老眼昏花" class="headerlink" title="问鼎杯 2017 老眼昏花"></a>问鼎杯 2017 老眼昏花</h5><p>网上很多 write-up 感觉就像是看着答案写 write-up，个人感觉真正的 write-up 中应该体现自己的思考在里面。</p>
<h3 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h3><p><img src="/images/15170519199340.jpg" alt=""></p>
<p>题目言简意赅，让我们把<code>2017</code>这个值传递给服务器。</p>
<h3 id="考察点"><a href="#考察点" class="headerlink" title="考察点"></a>考察点</h3><ul>
<li>PHP 浮点精确度</li>
</ul>
<h4 id="write-up"><a href="#write-up" class="headerlink" title="write-up"></a>write-up</h4><p><code>what year is this?</code> 所以第一反应是直接给 <code>year</code> 参数赋值为<code>2017</code>:<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?<span class="attribute">year</span>=2017</span><br></pre></td></tr></table></figure></p>
<p>然而结果如下：<br><img src="/images/15170520955165.jpg" alt=""></p>
<p>有提示了，说明<code>year</code>这个参数是对的，但是<code>2017</code>中不可以出现<code>7</code>，这里如果不了解 php 精度的话，肯定是对<code>2017</code>进行各种编码绕过, 但是这里对编码也进行过滤了：<br><img src="/images/15171915115543.png" alt=""></p>
<p>所以最后一种可能就是利用 PHP 精度来绕过:<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?<span class="attribute">year</span>=2016.99999999999</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/15170528059980.png" alt=""></p>
<h3 id="类型转换的缺陷"><a href="#类型转换的缺陷" class="headerlink" title="类型转换的缺陷"></a>类型转换的缺陷</h3><h4 id="理论-1"><a href="#理论-1" class="headerlink" title="理论"></a>理论</h4><p>PHP 提供了<code>is_numeric</code>函数，用来变量判断是否为数字。PHP 弱类型语言的一个特性，当一个整形和一个其他类型行比较的时候，会先把其他类型 intval 数字化再比。</p>
<h4 id="实践-1"><a href="#实践-1" class="headerlink" title="实践"></a>实践</h4><p><code>is_numeric()</code>用于判断是否是数字，通常配合数值判断。</p>
<h4 id="案例代码"><a href="#案例代码" class="headerlink" title="案例代码"></a>案例代码</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">    error_reporting(<span class="number">0</span>);</span></span><br><span class="line"><span class="php">    $flag = <span class="string">'flag&#123;1S_numer1c_Not_S4fe&#125;'</span>;</span></span><br><span class="line"><span class="php">    $id = $_GET[<span class="string">'id'</span>];</span></span><br><span class="line"><span class="php">    is_numeric($id)?<span class="keyword">die</span>(<span class="string">"Sorry...."</span>):<span class="keyword">NULL</span>;    </span></span><br><span class="line"><span class="php">    <span class="keyword">if</span>($id&gt;<span class="number">665</span>)&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> $flag;</span></span><br><span class="line"><span class="php">    &#125; </span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<h4 id="考察点-1"><a href="#考察点-1" class="headerlink" title="考察点"></a>考察点</h4><ul>
<li>PHP 类型转换缺陷</li>
</ul>
<h4 id="write-up-1"><a href="#write-up-1" class="headerlink" title="write-up"></a>write-up</h4><p>分析下代码: 首先对 GET 方式提交的参数<code>id</code>的值进行检验。<code>id</code>通过<code>is_numeric</code>函数来判断是否为数字，如果为数字的话，GG。如果不是数字的话，和<code>665</code>进行比较，<code>id</code>的值大于<code>665</code>的时候输出<code>flag</code>。<br>乍看上去又好像不可能这里，但是如果知道<code>PHP弱类型语言的一个特性，当一个整形和一个其他类型行比较的时候，会先把其他类型intval数字化再比</code>。这个特性的话就可以很好的绕过。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span><span class="comment">//localhost/?id=666gg</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/15171303549975.png" alt=""></p>
<h3 id="松散比较符的缺陷"><a href="#松散比较符的缺陷" class="headerlink" title="松散比较符的缺陷"></a>松散比较符的缺陷</h3><h4 id="理论-2"><a href="#理论-2" class="headerlink" title="理论"></a>理论</h4><p>php 比较相等性的运算符有两种，一种是严格比较，另一种是松散比较。</p>
<blockquote>
<p>如果比较一个数字和字符串或者比较涉及到数字内容的字符串，则字符串会被转换成数值并且比较按照数值来进行</p>
</blockquote>
<p><img src="/images/15167718268515.png" alt=""></p>
<h5 id="严格比较符"><a href="#严格比较符" class="headerlink" title="严格比较符"></a>严格比较符</h5><p>严格比较符，会先判断两种字符串的类型是否相等，再比较。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">===   //全等</span></span><br><span class="line">!==   //不全等</span><br></pre></td></tr></table></figure>
<p><img src="/images/15170583823430.png" alt=""></p>
<h5 id="松散比较符"><a href="#松散比较符" class="headerlink" title="松散比较符"></a>松散比较符</h5><p>松散比较符，会先将字符串类型转换成相同，再比较。<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">==   //等于</span></span><br><span class="line">!=   //不等</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/15170583319162.png" alt=""></p>
<p>PHP 会根据变量的值，自动把变量转换为正确的数据类型。这一点和 C 和 C++ 以及 Java 之类的语言明显不同。虽然这样 PHP 方便了程序员，但是随之而来却会带来一些安全性的问题。</p>
<h4 id="一个简单的例子"><a href="#一个简单的例子" class="headerlink" title="一个简单的例子"></a>一个简单的例子</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">    $a = <span class="keyword">null</span>;</span></span><br><span class="line"><span class="php">    $b = <span class="keyword">false</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> $a==$b;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span></span><br><span class="line"><span class="php">    $c = <span class="string">""</span>;</span></span><br><span class="line"><span class="php">    $d = <span class="number">0</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> $c==$d</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>由于 php 对变量自动转换的特性，这里面的<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">a==<span class="variable">$b</span> 与 <span class="variable">$c</span>==<span class="variable">$d</span> 均为真</span></span><br></pre></td></tr></table></figure></p>
<p>所以页面输出的结果为:<br><img src="/images/15167004076555.png" alt=""></p>
<h4 id="一个深入的例子"><a href="#一个深入的例子" class="headerlink" title="一个深入的例子"></a>一个深入的例子</h4><p><img src="/images/15167738799137.png" alt=""></p>
<p>下面结合 PHP 相等性比较缺陷再解释下会好懂一点:<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">var_dump</span>(<span class="number">0</span>==<span class="string">"gg"</span>);  <span class="comment">//true</span></span><br><span class="line"><span class="selector-tag">var_dump</span>(<span class="number">0</span>===<span class="string">"gg"</span>); <span class="comment">//false</span></span><br><span class="line"><span class="selector-tag">var_dump</span>(<span class="number">1</span>==<span class="string">"gg"</span>);  <span class="comment">//false</span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<p><code>0</code>与<code>gg</code>进行松散性质的不严格比较，会将<code>gg</code>转换为数值，强制转换，由于<code>gg</code>是字符串，转化的结果是<code>0</code>, 所以 输出 <code>true</code></p>
</blockquote>
<blockquote>
<p><code>0</code>与<code>gg</code>进行严格 性质的严格比较，这里的<code>gg</code>是字符串类型，和 <code>int</code> 类型的<code>0</code>不相等，所以输出 <code>false</code></p>
</blockquote>
<blockquote>
<p><code>0</code>与<code>gg</code>进行松散性质的不严格比较，会将<code>gg</code>转换为数值，强制转换，由于<code>gg</code>是字符串，转化的结果是<code>0</code>, 不等于<code>1</code>，所以输出 <code>false</code></p>
</blockquote>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">var_dump</span>(<span class="number">1</span>==<span class="string">"1gg"</span>); <span class="comment">//true </span></span><br><span class="line"><span class="selector-tag">var_dump</span>(<span class="number">1</span>==<span class="string">"gg1"</span>); <span class="comment">//false</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>1</code>与<code>1gg</code>进行松散性质的不严格比较，这里<code>1gg</code>被强制转换为 <code>int</code> 类型的时候会从字符串的第一位开始做判断进行转换，这里的<code>1gg</code>第一位是<code>1</code>，所以这里<code>1gg</code>被转换为<code>1</code>，所以输出 <code>true</code></p>
</blockquote>
<blockquote>
<p><code>1</code>与<code>gg1</code>进行严格 性质的严格比较，字符串<code>gg1</code>的第一位不是数字，所以它被强制转换为<code>0</code>，所以输出 <code>false</code></p>
</blockquote>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">var_dump</span>(<span class="string">"0e123"</span> == <span class="string">"0e456"</span>);  <span class="comment">//true</span></span><br><span class="line"><span class="selector-tag">var_dump</span>(<span class="string">"0e123"</span> == <span class="string">"0eabc"</span>);  <span class="comment">//flase</span></span><br></pre></td></tr></table></figure>
<p>这里比较特殊，字符串中出现了<code>0e</code>，PHP 手册介绍如下:</p>
<blockquote>
<p>当一个字符串欸当作一个数值来取值，其结果和类型如下:如果该字符串没有包含’.’,’e’,’E’并且其数值值在整形的范围之内该字符串被当作int来取值，其他所有情况下都被作为float来取值，该字符串的开始部分决定了它的值，如果该字符串以合法的数值开始，则使用该数值，否则其值为0。</p>
</blockquote>
<blockquote>
<p><code>0e123</code>与<code>0e456</code>相互不严格性质比较的时候，会将<code>0e</code>这类字符串识为科学技术法的数字,0 的无论多少次方都是零，所以相等, 输出 <code>true</code></p>
</blockquote>
<blockquote>
<p><code>0e123</code>与<code>0eabc</code>相互进行不严格性质比较的时候，本应该将<code>0e</code>这类字符串识为科学技术法的数字, 但是这里的<code>0e</code>后面跟着的是<code>abc</code>, 数学中科学计数的指数不可以包含字母。所以这里字符串中虽然是<code>0e</code>开头，但是后面的abc却不符合科学技法的规范，所以输出是 <code>false</code></p>
</blockquote>
<h3 id="实践-2"><a href="#实践-2" class="headerlink" title="实践"></a>实践</h3><h5 id="md5-绕过-Hash-比较缺陷"><a href="#md5-绕过-Hash-比较缺陷" class="headerlink" title="md5 绕过 (Hash 比较缺陷)"></a>md5 绕过 (Hash 比较缺陷)</h5><p>南京邮电大学网络攻防训练平台中一道比较经典的<code>md5 collision</code>题，关于这道题目的 WriteUp 网上很多，但是真正深入分析的少之又少~~</p>
<h3 id="题目描述-1"><a href="#题目描述-1" class="headerlink" title="题目描述"></a>题目描述</h3><h5 id="md5-collision"><a href="#md5-collision" class="headerlink" title="md5 collision"></a>md5 collision</h5><p>源码</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">    $md51 = md5(<span class="string">'QNKCDZO'</span>);</span></span><br><span class="line"><span class="php">    $a = @$_GET[<span class="string">'a'</span>];</span></span><br><span class="line"><span class="php">    $md52 = @md5($a);</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span>(<span class="keyword">isset</span>($a))&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> ($a != <span class="string">'QNKCDZO'</span> &amp;&amp; $md51 == $md52) &#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">echo</span> <span class="string">"nctf&#123;*****************&#125;"</span>;</span></span><br><span class="line"><span class="php">        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">echo</span> <span class="string">"false!!!"</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    <span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="string">"please input a"</span>;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<h3 id="考察点-2"><a href="#考察点-2" class="headerlink" title="考察点"></a>考察点</h3><ul>
<li>简单的 PHP 代码审计</li>
<li>PHP 弱类型的 Hash 比较缺陷</li>
</ul>
<h4 id="write-up-2"><a href="#write-up-2" class="headerlink" title="write-up"></a>write-up</h4><p>从源码中可以得输入一个 a 的参数的变量，a 首先不等于<code>QNKCDZO</code>并且 a 得 md5 值必须等于<code>QNKCDZO</code>加密后的 md5 值。<br>乍一看好像不可能存在这样的值，但是这里<code>QNKCDZO</code>加密后的 md5 值为<code>0e830400451993494058024219903391</code> 这里是<code>0e</code>开头的，在进行等于比较的时候，PHP 把它当作科学计数法，0 的无论多少次方都是零。 所以这里利用上面的弱类型的比较的缺陷来进行解题：<code>?a=s155964671a</code></p>
<p><img src="/images/15167786802641.png" alt=""> </p>
<p>字符串加密后<code>md5</code>为 <code>0exxxx</code> 的字符串 (x 必须是 10 进制数字) 列表</p>
<p>|  字符串     |              md5<br>|QNKCDZO     | 0e830400451993494058024219903391|<br>|240610708   | 0e462097431906509019562988736854|<br>|aabg7XSs    | 0e087386482136013740957780965295|<br>|aabC9RqS    | 0e041022518165728065344349536299|<br>|s878926199a | 0e545993274517709034328855841020|<br>|s155964671a | 0e342768416822451524974117254469|<br>|s214587387a | 0e848240448830537924465865611904|<br>|s214587387a | 0e848240448830537924465865611904|<br>|s878926199a | 0e545993274517709034328855841020|<br>|s1091221200a| 0e940624217856561557816327384675|<br>|s1885207154a| 0e509367213418206700842008763514|</p>
<h3 id="sha1-md5-加密函数漏洞缺陷"><a href="#sha1-md5-加密函数漏洞缺陷" class="headerlink" title="sha1() md5() 加密函数漏洞缺陷"></a>sha1() md5() 加密函数漏洞缺陷</h3><h3 id="理论-3"><a href="#理论-3" class="headerlink" title="理论"></a>理论</h3><p><code>md5()</code>和<code>sha1()</code>对一个数组进行加密将返回 NULL</p>
<h3 id="实践-3"><a href="#实践-3" class="headerlink" title="实践"></a>实践</h3><p>Boston Key Party CTF 2015: Prudential</p>
<h3 id="题目描述-2"><a href="#题目描述-2" class="headerlink" title="题目描述"></a>题目描述</h3><blockquote>
<p>I dont think sha1 isbroken.Prove me wrong.</p>
</blockquote>
<p>题目给了一个登陆框:<br><img src="/images/15171202342826.png" alt=""></p>
<h3 id="考察点-3"><a href="#考察点-3" class="headerlink" title="考察点"></a>考察点</h3><ul>
<li>sha1() 函数漏洞缺陷</li>
</ul>
<h4 id="write-up-3"><a href="#write-up-3" class="headerlink" title="write-up"></a>write-up</h4><p>源代码给出如下:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>level1<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">'stylesheet'</span> <span class="attr">href</span>=<span class="string">'style.css'</span> <span class="attr">type</span>=<span class="string">'text/css'</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="keyword">require</span> <span class="string">'flag.php'</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'name'</span>]) <span class="keyword">and</span> <span class="keyword">isset</span>($_GET[<span class="string">'password'</span>])) &#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> ($_GET[<span class="string">'name'</span>] == $_GET[<span class="string">'password'</span>])</span></span><br><span class="line"><span class="php">        <span class="keyword">print</span> <span class="string">'Your password can not be your name.'</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">else</span> <span class="keyword">if</span> (sha1($_GET[<span class="string">'name'</span>]) === sha1($_GET[<span class="string">'password'</span>]))</span></span><br><span class="line"><span class="php">      <span class="keyword">die</span>(<span class="string">'Flag: '</span>.$flag);</span></span><br><span class="line"><span class="php">    <span class="keyword">else</span></span></span><br><span class="line"><span class="php">        <span class="keyword">print</span> <span class="string">'&lt;p class="alert"&gt;Invalid password.&lt;/p&gt;'</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">"login"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"title"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"./index.txt"</span>&gt;</span>Level 1<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"get"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">required</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">placeholder</span>=<span class="string">"Name"</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">required</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">placeholder</span>=<span class="string">"Password"</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>分析一下核心登录代码如下:</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($_GET[<span class="string">'name'</span>] == $_GET[<span class="string">'password'</span>])</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'Your password can not be your name.'</span>;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (sha1($_GET[<span class="string">'name'</span>]) === sha1($_GET[<span class="string">'password'</span>]))</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Flag: '</span>.$flag);</span><br></pre></td></tr></table></figure>
<p><code>GET</code>类型提交了两个字段<code>name</code>和<code>password</code>，获得 flag 要求的条件是：</p>
<ul>
<li>name != password</li>
<li>sha1(name) == sha1(password)</li>
</ul>
<p>这个乍看起来这是不可能的，但是这里利用<code>sha1()</code>函数在处理数组的时候由于无法处理将返回<code>NULL</code>可以绕过 if 语句的验证，if 条件成立将获得<code>flag</code>。<br>构造语句如下:</p>
<blockquote>
<p>?name[]=a&amp;password[]=b</p>
</blockquote>
<p>这里符合了 2 个拿到 flag 的条件：</p>
<ul>
<li>a 不等于 b</li>
<li>name 和 password 由于是数组，经过 sha1() 函数嫁给后都返回<code>NULL</code></li>
</ul>
<p>拿到 flag： <code>I_think_that_I_just_broke_sha1</code></p>
<h3 id="拓展总结"><a href="#拓展总结" class="headerlink" title="拓展总结"></a>拓展总结</h3><p>经过验证，不仅<code>sha1()</code>函数无法处理数组，这里<code>md5()</code>函数也有同样的问题，在处理数组的时候，都将返回<code>NULL</code><br>测试代码如下:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">error_reporting(<span class="number">0</span>);</span></span><br><span class="line"><span class="php">$flag = <span class="string">'flag&#123;I_think_that_I_just_broke_md5&#125;'</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'username'</span>]) <span class="keyword">and</span> <span class="keyword">isset</span>($_GET[<span class="string">'password'</span>])) &#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> ($_GET[<span class="string">'username'</span>] == $_GET[<span class="string">'password'</span>])</span></span><br><span class="line"><span class="php">        <span class="keyword">print</span> <span class="string">'Your password can not be your username.'</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">else</span> <span class="keyword">if</span> (md5($_GET[<span class="string">'username'</span>]) === sha1($_GET[<span class="string">'password'</span>]))</span></span><br><span class="line"><span class="php">        <span class="keyword">die</span>($flag);</span></span><br><span class="line"><span class="php">    <span class="keyword">else</span></span></span><br><span class="line"><span class="php">        <span class="keyword">print</span> <span class="string">'Invalid password'</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>这里面的核心代码如下:</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($_GET[<span class="string">'username'</span>] == $_GET[<span class="string">'password'</span>])</span><br><span class="line"><span class="meta">#并且得满足:</span></span><br><span class="line"><span class="keyword">if</span> (md5($_GET[<span class="string">'username'</span>]) === sha1($_GET[<span class="string">'password'</span>]))</span><br></pre></td></tr></table></figure>
<p>同样利用 <code>md5()</code>函数无法处理数组的这个漏洞，构造 get 请求拿到 flag:</p>
<blockquote>
<p>?username[]=a&amp;password[]=b</p>
</blockquote>
<p><img src="/images/15171211572131.png" alt=""></p>
<h3 id="字符串处理函数漏洞缺陷"><a href="#字符串处理函数漏洞缺陷" class="headerlink" title="字符串处理函数漏洞缺陷"></a>字符串处理函数漏洞缺陷</h3><h3 id="理论-4"><a href="#理论-4" class="headerlink" title="理论"></a>理论</h3><ul>
<li><code>strcmp()</code>函数: 比较两个字符串（区分大小写).<br>用法如下:</li>
</ul>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> <span class="keyword">strcmp</span> ( <span class="keyword">string</span> $str1 , <span class="keyword">string</span> $str2 )</span><br></pre></td></tr></table></figure>
<p>具体的用法解释如下:<br><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">参数 `str1`第一个字符串。</span><br><span class="line">参数 `str2`第二个字符串。</span><br><span class="line">如果 `str1` 小于 `str2` 返回 `&lt; <span class="number">0</span>`；</span><br><span class="line">如果 `str1` 大于 `str2` 返回 `&gt; <span class="number">0</span>`；</span><br><span class="line">如果两者相等，返回 <span class="number">0</span>。</span><br></pre></td></tr></table></figure></p>
<p>这个函数接受到了不符合的类型，例如<code>数组</code>类型, 函数将发生错误。但是在<code>5.3</code>之前的 php 中，显示了报错的警告信息后，将<code>return 0</code> !!!! 也就是虽然报了错，但却判定其相等了。</p>
<ul>
<li><code>ereg()</code>函数：字符串正则匹配。</li>
<li><code>strpos()</code>函数：查找字符串在另一字符串中第一次出现的位置，对大小写敏感。</li>
</ul>
<p>这 2 个函数都是用来处理字符串的，但是在传入数组参数后都将返回<code>NULL</code>。</p>
<h3 id="实践-4"><a href="#实践-4" class="headerlink" title="实践"></a>实践</h3><p>Boston Key Party CTF 2015: Northeastern Univ</p>
<h3 id="题目描述-3"><a href="#题目描述-3" class="headerlink" title="题目描述"></a>题目描述</h3><p>Of course, a timing attack might be the answer, but Im quite sure that you can do better than that.<br>题目给了一个登陆框:<br><img src="/images/15171245693910.png" alt=""></p>
<h3 id="考察点-4"><a href="#考察点-4" class="headerlink" title="考察点"></a>考察点</h3><ul>
<li>字符串处理函数漏洞缺陷</li>
</ul>
<h4 id="write-up-4"><a href="#write-up-4" class="headerlink" title="write-up"></a>write-up</h4><p>给出源代码如下:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>level3<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">'stylesheet'</span> <span class="attr">href</span>=<span class="string">'style.css'</span> <span class="attr">type</span>=<span class="string">'text/css'</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="keyword">require</span> <span class="string">'flag.php'</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'password'</span>])) &#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> (strcmp($_GET[<span class="string">'password'</span>], $flag) == <span class="number">0</span>)</span></span><br><span class="line"><span class="php">        <span class="keyword">die</span>(<span class="string">'Flag: '</span>.$flag);</span></span><br><span class="line"><span class="php">    <span class="keyword">else</span></span></span><br><span class="line"><span class="php">        <span class="keyword">print</span> <span class="string">'&lt;p class="alert"&gt;Invalid password.&lt;/p&gt;'</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">"login"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"title"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"./index.txt"</span>&gt;</span>Level 3<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"get"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">required</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">placeholder</span>=<span class="string">"Password"</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>分析一下核心登录代码如下:<br><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">strcmp</span>($_GET[<span class="string">'password'</span>], $flag) == <span class="number">0</span>)</span><br></pre></td></tr></table></figure></p>
<p>这里使用了<code>==</code>松散比较了<code>$flag</code>和通过 GET 方式提交的<code>password</code>的值，如果想等的话，拿到 flag。<br>这里用的是<code>==</code>松散性质的比较，再利用字符串处理数组时将会报错，在<code>5.3</code>之前的 php 中，显示了报错的警告信息后，将<code>return 0</code>。所有这里将<code>password</code>参数指定为数组, 利用函数漏洞拿到<code>flag</code>:<br><img src="/images/15171263473948.png" alt=""> </p>
<h3 id="拓展总结-1"><a href="#拓展总结-1" class="headerlink" title="拓展总结"></a>拓展总结</h3><p>除了<code>strcmp()</code>函数外，<code>ereg()</code>和<code>strpos()</code>函数在处理数组的时候也会异常，返回<code>NULL</code>。<br>测试代码如下:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">    error_reporting(<span class="number">0</span>);</span></span><br><span class="line"><span class="php">    $flag = <span class="string">'flag&#123;P@ssw0rd_1s_n0t_s4fe_By_d0uble_Equ4ls&#125;'</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> (<span class="keyword">isset</span> ($_GET[<span class="string">'password'</span>])) &#123;  </span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> (ereg (<span class="string">"^[a-zA-Z0-9]+$"</span>, $_GET[<span class="string">'password'</span>]) === <span class="keyword">FALSE</span>)  </span></span><br><span class="line"><span class="php">            <span class="keyword">echo</span> <span class="string">'You password must be alphanumeric'</span>;  </span></span><br><span class="line"><span class="php">        <span class="keyword">else</span> <span class="keyword">if</span> (strpos ($_GET[<span class="string">'password'</span>], <span class="string">'--'</span>) !== <span class="keyword">FALSE</span>)  </span></span><br><span class="line"><span class="php">            <span class="keyword">die</span>($flag);  </span></span><br><span class="line"><span class="php">        <span class="keyword">else</span>  </span></span><br><span class="line"><span class="php">            <span class="keyword">echo</span> <span class="string">'Invalid password'</span>;  </span></span><br><span class="line"><span class="php">    &#125;  </span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>将参数 password 赋值一个数组传递进去：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="link">http://localhost/?password</span>[<span class="string"></span>]=gg</span><br></pre></td></tr></table></figure>
<p><code>ereg()函数</code> 是处理字符串的，传入数组后返回<code>NULL</code>，<code>NULL</code>和 <code>FALSE</code>，是不恒等（===）的，满足第一个<code>if</code>条件；而<code>strpos()函数</code>也是处理字符串的，传入数组后返回<code>NULL</code>，<code>NULL!==FALSE</code>，满足条件，拿到 flag:<br><img src="/images/15171277886030.png" alt=""> </p>
<h3 id="parse-str-函数变量覆盖缺陷"><a href="#parse-str-函数变量覆盖缺陷" class="headerlink" title="parse_str 函数变量覆盖缺陷"></a>parse_str 函数变量覆盖缺陷</h3><h3 id="理论-5"><a href="#理论-5" class="headerlink" title="理论"></a>理论</h3><p><code>parse_str</code> 函数的作用就是解析字符串并注册成变量，在注册变量之前不会验证当前变量是否存在，所以直接覆盖掉已有变量。</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">void parse_str ( string $str [,<span class="built_in"> array </span>&amp;$arr ] )</span><br></pre></td></tr></table></figure>
<p>str 输入的字符串。<br>arr 如果设置了第二个变量 arr，变量将会以数组元素的形式存入到这个数组，作为替代。</p>
<h3 id="实践-5"><a href="#实践-5" class="headerlink" title="实践"></a>实践</h3><p>测试代码:</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$flag</span> = <span class="string">'flag&#123;V4ri4ble_M4y_Be_C0verEd&#125;'</span>;</span><br><span class="line"><span class="keyword">if</span> (empty(<span class="variable">$_GET</span>[<span class="string">'b'</span>])) &#123;</span><br><span class="line">    show_source(__FILE__);</span><br><span class="line">    die();</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$a</span> = <span class="string">"www.sqlsec.com"</span>;</span><br><span class="line">    <span class="variable">$b</span> = <span class="variable">$_GET</span>[<span class="string">'b'</span>];</span><br><span class="line">    @parse_str(<span class="variable">$b</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$a</span>[<span class="number">0</span>] != <span class="string">'QNKCDZO'</span> &amp;&amp; md5(<span class="variable">$a</span>[<span class="number">0</span>]) == md5(<span class="string">'QNKCDZO'</span>)) &#123;</span><br><span class="line">        echo <span class="variable">$flag</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">'your answer is wrong~'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="考察点-5"><a href="#考察点-5" class="headerlink" title="考察点"></a>考察点</h3><ul>
<li>parse_str 变量覆盖缺陷</li>
</ul>
<h3 id="write-up-5"><a href="#write-up-5" class="headerlink" title="write-up"></a>write-up</h3><p>找到核心代码:</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">@parse_str</span>($b)<span class="comment">;</span></span><br><span class="line"><span class="meta">#这里使用了parse_str函数来传递b的变量值</span></span><br><span class="line"><span class="keyword">if</span> ($a[0] != <span class="string">'QNKCDZO'</span> &amp;&amp; md5($a[0]) == md5(<span class="string">'QNKCDZO'</span>))</span><br><span class="line"><span class="meta">#这里用到的是文章上面的知识点md5()函数缺陷</span></span><br></pre></td></tr></table></figure>
<p>因为这里用到了<code>parse_str</code>函数来传递<code>b</code>，if 的语句的条件是拿<code>$a[0]</code>来比较的，有因为这里的变量 a 的值已经三是固定的了:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">a = <span class="string">"www.sqlsec.com"</span>;</span></span><br></pre></td></tr></table></figure>
<p>这里其实是我博客的地址~~ 不过不重要。<br>整体代码乍看起来又不可能，但是利用变量覆盖函数的缺陷这里可以对<code>a</code>的变量进行重新赋值，后面的的 if 语句再利用本文前面提到的<code>md5()</code>比较缺陷进行绕过:<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="link">http://localhost/?b=a</span>[<span class="string">0</span>]=240610708</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/15171333801974.png" alt=""></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yulongphp.github.io/2018/10/25/PHP 代码安全杂谈/" data-id="cjxleml1v0007qf8ylolx0fo5" class="article-share-link">分享到</a><div class="tags"><a href="/tags/php/">php</a><a href="/tags/安全/">安全</a></div><div class="post-nav"><a href="/2018/11/24/docker学习笔记二/" class="pre">docker学习笔记二</a><a href="/2018/10/24/docker学习笔记/" class="next">docker学习笔记</a></div><div id="disqus_thread"><script>var disqus_shortname = 'yulong';
var disqus_identifier = '2018/10/25/PHP 代码安全杂谈/';
var disqus_title = 'PHP 代码安全杂谈';
var disqus_url = 'http://yulongphp.github.io/2018/10/25/PHP 代码安全杂谈/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//yulong.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yulongphp.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MarkDown/">MarkDown</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/debian/">debian</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/">php</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/php7/">php7</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/sublime/">sublime</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/日志/">日志</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/php/" style="font-size: 15px;">php</a> <a href="/tags/安全/" style="font-size: 15px;">安全</a> <a href="/tags/list/" style="font-size: 15px;">list</a> <a href="/tags/tuple/" style="font-size: 15px;">tuple</a> <a href="/tags/debian/" style="font-size: 15px;">debian</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/MarkDown/" style="font-size: 15px;">MarkDown</a> <a href="/tags/hack/" style="font-size: 15px;">hack</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/service/" style="font-size: 15px;">service</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/C/" style="font-size: 15px;">C</a> <a href="/tags/php7/" style="font-size: 15px;">php7</a> <a href="/tags/tcl/" style="font-size: 15px;">tcl</a> <a href="/tags/tk/" style="font-size: 15px;">tk</a> <a href="/tags/sed/" style="font-size: 15px;">sed</a> <a href="/tags/vim/" style="font-size: 15px;">vim</a> <a href="/tags/vsftp/" style="font-size: 15px;">vsftp</a> <a href="/tags/开始/" style="font-size: 15px;">开始</a> <a href="/tags/我/" style="font-size: 15px;">我</a> <a href="/tags/日记/" style="font-size: 15px;">日记</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/sublime/" style="font-size: 15px;">sublime</a> <a href="/tags/ubuntu/" style="font-size: 15px;">ubuntu</a> <a href="/tags/sudo/" style="font-size: 15px;">sudo</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/06/27/mysql总结/">mysql总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/27/高性能mysql/">高性能mysql</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/25/mysql实战45讲/">mysql实战45讲</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/25/算法与数据结构/">算法与数据结构</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/25/sed/">sed常用命令</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/24/mysql实战章节小结/">myqsl实战章节小结</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/05/mysql查询优化/">mysql查询优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/05/分布式锁/">分布式锁</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/01/php部分语法的AST栈符号表和指令集/">php 部分语法的AST、栈、符号表、和指令集</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/30/php代码的编译和执行/">php 代码的编译与执行</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//yulong.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://yanshinian.com/" title="言十年" target="_blank">言十年</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Mryy的博客.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>